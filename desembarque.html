<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Buscar Empresa y Mostrar Datos</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #444;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
      cursor: default; /* cursor pointer se asignará dinámicamente a columnas clicables */
    }
  </style>
</head>
<body>

  <h1>Buscar Empresa</h1>
  <input type="text" id="busqueda" placeholder="Escribe el nombre de la empresa">
  <button id="btnBuscar">Buscar</button>
  <button id="btnMostrarTodas">Mostrar todas</button>

  <div id="resultado"></div>

  <h2>Datos desde JSON</h2>
  <table id="tabla-datos">
    <thead>
      <tr>
        <th>Empresa</th>
        <th>Origen</th>
        <th>Placa</th>
        <th>Fecha</th>
        <th>Entrada</th>
        <th>Salida</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  // Variable global para almacenar los datos
  let datosGlobales = [];

  // Estado de orden para columnas Entrada y Salida
  let ordenEntradaAsc = false;
  let ordenSalidaAsc = false;

  // Cargar datos desde JSON al iniciar
  fetch('csvjson.json')
    .then(response => response.json())
    .then(data => {
      datosGlobales = data;
      mostrarDatosEnTabla(datosGlobales);
      agregarEventosOrden();
    })
    .catch(error => {
      console.error('Error al cargar csvjson.json:', error);
      alert('No se pudo cargar csvjson.json. Asegúrate de usar un servidor local o que el archivo esté en la ruta correcta.');
    });

  // Función para mostrar datos en la tabla
  function mostrarDatosEnTabla(datos) {
    const tbody = document.querySelector('#tabla-datos tbody');
    tbody.innerHTML = ''; // Limpiar tabla

    if(datos.length === 0){
      tbody.innerHTML = `<tr><td colspan="6" style="color: red;">No se encontraron registros.</td></tr>`;
      return;
    }

    datos.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.Empresa || ''}</td>
        <td>${item.Origen || ''}</td>
        <td>${item.Placa || ''}</td>
        <td>${item.Fecha || ''}</td>
        <td>${item.Entrada || ''}</td>
        <td>${item.Salida || ''}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Referencias a botones y campo de búsqueda
  const btnBuscar = document.getElementById('btnBuscar');
  const btnMostrarTodas = document.getElementById('btnMostrarTodas');
  const inputBusqueda = document.getElementById('busqueda');
  const contenedorResultado = document.getElementById('resultado');

  // Evento para buscar empresa
  btnBuscar.addEventListener('click', () => {
    const nombre = inputBusqueda.value.trim().toUpperCase();

    // Filtrar usando includes para coincidencias parciales
    const coincidencias = datosGlobales.filter(item =>
      String(item.Empresa || '').trim().toUpperCase().includes(nombre)
    );

    if (coincidencias.length > 0) {
      contenedorResultado.innerHTML = ''; // Limpiar mensajes
      mostrarDatosEnTabla(coincidencias);
    } else {
      contenedorResultado.innerHTML = '<p style="color: red;">Empresa no encontrada.</p>';
      mostrarDatosEnTabla([]);
    }
  });

  // Evento para mostrar todas las empresas
  btnMostrarTodas.addEventListener('click', () => {
    contenedorResultado.innerHTML = '';
    mostrarDatosEnTabla(datosGlobales);
    inputBusqueda.value = '';
  });

  // Agregar eventos de ordenamiento a columnas Entrada y Salida
  function agregarEventosOrden() {
    const thEntrada = document.querySelector('th:nth-child(5)'); // columna Entrada
    const thSalida = document.querySelector('th:nth-child(6)');   // columna Salida

    thEntrada.style.cursor = 'pointer';
    thSalida.style.cursor = 'pointer';

    thEntrada.addEventListener('click', () => {
      ordenEntradaAsc = !ordenEntradaAsc; // alterna entre asc y desc
      datosGlobales.sort((a, b) => {
        const horaA = parseHora(a.Entrada);
        const horaB = parseHora(b.Entrada);
        return ordenEntradaAsc ? horaA - horaB : horaB - horaA;
      });
      mostrarDatosEnTabla(datosGlobales);
    });

    thSalida.addEventListener('click', () => {
      ordenSalidaAsc = !ordenSalidaAsc;
      datosGlobales.sort((a, b) => {
        const horaA = parseHora(a.Salida);
        const horaB = parseHora(b.Salida);
        return ordenSalidaAsc ? horaA - horaB : horaB - horaA;
      });
      mostrarDatosEnTabla(datosGlobales);
    });
  }

  // Función para convertir "HH:MM" o "HH:MM:SS" a minutos o segundos para ordenar
  function parseHora(horaStr) {
    if (!horaStr) return 0;
    const partes = horaStr.split(':').map(Number);
    if (partes.length === 2) {
      return partes[0] * 60 + partes[1]; // minutos totales
    } else if (partes.length === 3) {
      return partes[0] * 3600 + partes[1] * 60 + partes[2]; // segundos totales
    }
    return 0;
  }
</script>

</body>
</html>
